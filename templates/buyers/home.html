{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeFood Connect - Home Cooked Meals</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <!-- Custom FOODIED Style CSS -->
    <link rel="stylesheet" href="{% static 'css/foodied.css' %}?v=1">
    
    <!-- Leaflet.js CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="foodied-theme">

    <!-- ============= NAVIGATION ============= -->
    <nav class="foodied-nav">
        <div class="nav-container">
            <a href="{% url 'buyers:home' %}" class="nav-logo">
                <i class="fas fa-utensils"></i>
                <span>HomeFood</span>
            </a>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="{% url 'buyers:home' %}" class="active">Home</a></li>
                <li><a href="#menu">Menu</a></li>
                <li><a href="#about">About Us</a></li>
                <li><a href="#how-it-works">How It Works</a></li>
                {% if user.is_authenticated %}
                    {% if user.user_type == 'cook' %}
                    <li><a href="{% url 'cooks:dashboard' %}">Dashboard</a></li>
                    {% elif user.user_type == 'buyer' %}
                    <li><a href="{% url 'buyers:orders' %}">My Orders</a></li>
                    {% endif %}
                {% endif %}
            </ul>
            
            <div class="nav-actions">
                <a href="{% url 'buyers:search' %}" class="nav-icon" title="Search">
                    <i class="fas fa-search"></i>
                </a>
                {% if user.is_authenticated %}
                <a href="{% url 'accounts:profile' %}" class="nav-icon" title="Profile">
                    <i class="fas fa-user"></i>
                </a>
                <a href="{% url 'accounts:logout' %}" class="nav-signup-btn">Logout</a>
                {% else %}
                <a href="{% url 'accounts:login' %}" class="nav-icon" title="Login">
                    <i class="fas fa-user"></i>
                </a>
                <a href="{% url 'accounts:register' %}" class="nav-signup-btn">Sign Up</a>
                {% endif %}
            </div>
            
            <div class="nav-toggle" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- ============= HERO SECTION ============= -->
    <section class="hero-section">
        <div class="hero-container">
            <div class="hero-content">
                <span class="hero-tag">üçΩÔ∏è Hungry?</span>
                <h1 class="hero-title">
                    JUST COME TO<br>
                    <span>HOMEFOOD</span> & ORDER
                </h1>
                <p class="hero-subtitle">
                    Here You Will Find All The Best Quality And Pure Home-Cooked Food. Order Now To Satisfy Your Hunger Pangs With Authentic Flavors.
                </p>
                <div class="hero-buttons">
                    <a href="#menu" class="btn-primary-foodied">
                        Order Now <i class="fas fa-arrow-right"></i>
                    </a>
                    <button id="find-nearby-meals" class="btn-primary-foodied" style="margin-left: 10px;">
                        Find Meals Near Me <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="hero-visual">
                <div class="hero-image-container">
                    <div class="hero-main-image">
                        <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=500" alt="Delicious Food">
                    </div>
                    <div class="floating-food floating-food-1">
                        <img src="https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=150" alt="Food">
                    </div>
                    <div class="floating-food floating-food-2">
                        <img src="https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=150" alt="Food">
                    </div>
                    <div class="floating-food floating-food-3">
                        <img src="https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=150" alt="Food">
                    </div>
                </div>
            </div>
        </div>
        <div id="location-error-message" style="color: red; margin-top: 10px; display: none;"></div>
        <div id="manual-address-input" style="display: none; margin-top: 10px;">
            <input type="text" id="address-input" placeholder="Enter your address" style="padding: 6px; width: 250px;">
            <button id="submit-address" class="btn-outline-foodied">Search by Address</button>
        </div>
        <div id="nearby-meals-map" style="width: 100%; height: 400px; margin-top: 20px; display: none;"></div>
    </section>
    <script src="{% static 'js/buyer_home.js' %}"></script>

    <!-- ============= FEATURED MEALS SECTION ============= -->
    <section class="meals-section" id="menu">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">Featured Meals</h2>
                <p class="section-subtitle">Discover delicious home-cooked meals from verified local cooks</p>
            </div>
            <div class="meals-grid">
                {% for meal in meals %}
                <div class="meal-card">
                    <div class="meal-card-image">
                        {% if meal.images.first %}
                        <img src="{{ meal.images.first.image.url }}" alt="{{ meal.name }}">
                        {% else %}
                        <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400" alt="{{ meal.name }}">
                        {% endif %}
                        {% if meal.is_available and meal.has_active_slot %}
                        <span class="meal-card-badge">Available</span>
                        {% endif %}
                    </div>
                    <div class="meal-card-content">
                        <h3 class="meal-card-title">{{ meal.name }}</h3>
                        <p class="meal-card-desc">{{ meal.description|truncatewords:8 }}</p>
                    </div>
                    <div class="meal-card-footer">
                        <span class="meal-price">‚Çπ{{ meal.price }}</span>
                        <a href="{% url 'buyers:meal_detail' meal.pk %}" class="meal-btn">Buy Now</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- ============= HEALTHY DIETS SECTION ============= -->
    <section class="meals-section" id="healthy-diets">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">Healthy Diets</h2>
                <p class="section-subtitle">Salads and health-focused meals for a nutritious lifestyle</p>
            </div>
            <div class="meals-grid">
                {% for healthy in healthy_diets %}
                <div class="meal-card">
                    <div class="meal-card-image">
                        {% if healthy.meal.images.first %}
                        <img src="{{ healthy.meal.images.first.image.url }}" alt="{{ healthy.meal.name }}">
                        {% else %}
                        <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=400" alt="{{ healthy.meal.name }}">
                        {% endif %}
                        {% if healthy.meal.is_available %}
                        <span class="meal-card-badge">Healthy</span>
                        {% endif %}
                    </div>
                    <div class="meal-card-content">
                        <h3 class="meal-card-title">{{ healthy.meal.name }}</h3>
                        <p class="meal-card-desc">{{ healthy.meal.description|truncatewords:8 }}</p>
                        <div class="meal-tags">
                            {% for tag in healthy.dietary_tags %}
                                <span class="badge bg-success" style="margin-right: 4px;">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="meal-card-footer">
                        <span class="meal-price">‚Çπ{{ healthy.meal.price }}</span>
                        <a href="{% url 'buyers:meal_detail' healthy.meal.pk %}" class="meal-btn">View</a>
                    </div>
                </div>
                {% empty %}
                <div class="meal-card">
                    <div class="meal-card-content">
                        <h3 class="meal-card-title">No healthy meals available right now.</h3>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- ============= WHY CHOOSE US SECTION ============= -->
    <section class="why-section" id="about">
        <div class="section-container">
            <div class="why-header">
                <h2 class="why-title">WHY CHOOSE US?</h2>
                <p class="why-subtitle">You will choose us because you get the best quality food from us and we deliver fast.</p>
            </div>
            
            <div class="why-grid">
                <div class="why-card">
                    <div class="why-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h3 class="why-card-title">Serve Healthy Food</h3>
                    <p class="why-card-desc">We serve all healthy food here. You can choose any food you like. All meals are prepared with fresh ingredients.</p>
                </div>
                
                <div class="why-card">
                    <div class="why-icon">
                        <i class="fas fa-award"></i>
                    </div>
                    <h3 class="why-card-title">Best Quality</h3>
                    <p class="why-card-desc">Our food quality is excellent. You will get exactly what you want here. Every cook is verified for quality.</p>
                </div>
                
                <div class="why-card">
                    <div class="why-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <h3 class="why-card-title">Easy Pickup</h3>
                    <p class="why-card-desc">You can say the main goal of our delivery man is to deliver orders quickly. You will receive it shortly after ordering.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- ============= HOW IT WORKS SECTION ============= -->
    <section class="how-section" id="how-it-works">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">How It Works</h2>
                <p class="section-subtitle">Get your favorite home-cooked meal in 3 easy steps</p>
            </div>
            
            <div class="how-grid">
                <div class="how-card">
                    <div class="how-number">1</div>
                    <h3 class="how-card-title">Browse Meals</h3>
                    <p class="how-card-desc">Explore delicious home-cooked meals from verified local cooks in your area.</p>
                </div>
                
                <div class="how-card">
                    <div class="how-number">2</div>
                    <h3 class="how-card-title">Place Order</h3>
                    <p class="how-card-desc">Select your favorite meal, choose a pickup slot, and place your order securely.</p>
                </div>
                
                <div class="how-card">
                    <div class="how-number">3</div>
                    <h3 class="how-card-title">Pickup & Enjoy</h3>
                    <p class="how-card-desc">Pick up your fresh, hot meal at the scheduled time and enjoy authentic flavors.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- ============= TOP COOKS SECTION ============= -->
    {% if verified_cooks %}
    <section class="cooks-section">
        <div class="section-container">
            <div class="section-header">
                <h2 class="section-title">Top Cooks</h2>
                <p class="section-subtitle">Meet our talented home cooks who prepare delicious meals with love</p>
            </div>
            
            <div class="cooks-grid">
                {% for cook in verified_cooks %}
                <div class="cook-card">
                    <div class="cook-card-image">
                        {% if cook.profile_image %}
                        <img src="{{ cook.profile_image.url }}" alt="{{ cook.user.username }}">
                        {% else %}
                        <img src="https://images.unsplash.com/photo-1577219491135-ce391730fb2c?w=400" alt="{{ cook.user.username }}">
                        {% endif %}
                    </div>
                    <div class="cook-card-content">
                        <h3 class="cook-card-name">{{ cook.user.username }}</h3>
                        <div class="cook-card-rating">
                            <i class="fas fa-star"></i>
                            <span>{{ cook.rating }}/5.0</span>
                            <span style="color: #999; margin-left: 5px;">({{ cook.total_reviews }} reviews)</span>
                        </div>
                        <p class="cook-card-location">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ cook.city }}, {{ cook.state }}
                        </p>
                        <a href="{% url 'buyers:cook_profile' cook.pk %}" class="cook-view-btn">View Profile</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Removed duplicate static NEARBY MEALS SECTION -->

    <!-- ============= CTA SECTION ============= -->
    <section style="padding: 80px 5%; background: linear-gradient(135deg, #4CAF50, #66BB6A); text-align: center;">
        <div class="section-container">
            <h2 style="font-size: 38px; font-weight: 700; color: white; margin-bottom: 20px;">Ready to Order?</h2>
            <p style="font-size: 18px; color: rgba(255,255,255,0.9); margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                Join thousands of food lovers who enjoy authentic home-cooked meals every day. Start your culinary journey now!
            </p>
            {% if not user.is_authenticated %}
            <a href="{% url 'accounts:register' %}" class="btn-primary-foodied" style="background: white; color: #4CAF50;">
                Get Started <i class="fas fa-arrow-right"></i>
            </a>
            {% else %}
            <a href="{% url 'buyers:search' %}" class="btn-primary-foodied" style="background: white; color: #4CAF50;">
                Explore Meals <i class="fas fa-arrow-right"></i>
            </a>
            {% endif %}
        </div>
    </section>

    <!-- ============= FOOTER ============= -->
    <footer class="foodied-footer">
        <div class="footer-container">
            <div class="footer-brand">
                <h3><i class="fas fa-utensils"></i> HomeFood</h3>
                <p>HomeFood Connect brings together passionate home cooks and food lovers. Discover authentic, home-cooked meals prepared with love and traditional recipes.</p>
                <div class="footer-social">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
            
            <div class="footer-col">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="{% url 'buyers:home' %}">Home</a></li>
                    <li><a href="#menu">Menu</a></li>
                    <li><a href="#about">About Us</a></li>
                    <li><a href="{% url 'buyers:search' %}">Search</a></li>
                </ul>
            </div>
            
            <div class="footer-col">
                <h4>For Users</h4>
                <ul>
                    {% if user.is_authenticated %}
                    <li><a href="{% url 'accounts:profile' %}">My Profile</a></li>
                    <li><a href="{% url 'buyers:orders' %}">My Orders</a></li>
                    <li><a href="{% url 'buyers:favorites' %}">Favorites</a></li>
                    {% else %}
                    <li><a href="{% url 'accounts:login' %}">Login</a></li>
                    <li><a href="{% url 'accounts:register' %}">Register</a></li>
                    {% endif %}
                </ul>
            </div>
            
            <div class="footer-col">
                <h4>For Cooks</h4>
                <ul>
                    <li><a href="{% url 'accounts:register' %}">Become a Cook</a></li>
                    {% if user.is_authenticated and user.user_type == 'cook' %}
                    <li><a href="{% url 'cooks:dashboard' %}">Dashboard</a></li>
                    <li><a href="{% url 'cooks:meals' %}">My Meals</a></li>
                    <li><a href="{% url 'cooks:orders' %}">Orders</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; {% now "Y" %} HomeFood Connect. All rights reserved. Made with ‚ù§Ô∏è for food lovers.</p>
        </div>
    </footer>

    <script>
        // Mobile menu toggle
        function toggleMenu() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('active');
        }
        
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
        
        // Navbar scroll effect
        window.addEventListener('scroll', function() {
            const nav = document.querySelector('.foodied-nav');
            if (window.scrollY > 50) {
                nav.style.boxShadow = '0 4px 30px rgba(0, 0, 0, 0.1)';
            } else {
                nav.style.boxShadow = '0 2px 20px rgba(0, 0, 0, 0.08)';
            }
        });

    document.getElementById('find-nearby-meals').addEventListener('click', function() {
        const errorDiv = document.getElementById('location-error-message');
        errorDiv.style.display = 'none';
        document.getElementById('manual-address-input').style.display = 'none';
        // Custom message before requesting location
        if (window.confirm('To find meals near you, we need access to your location. Do you want to allow location access?')) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        errorDiv.style.display = 'none';
                        fetchNearbyMealsList(position.coords.latitude, position.coords.longitude);
                    },
                    function(error) {
                        if (error.code === error.PERMISSION_DENIED) {
                            errorDiv.textContent = 'Location access denied. Please enter your address below.';
                            errorDiv.style.display = 'block';
                            document.getElementById('manual-address-input').style.display = 'block';
                        } else if (error.code === error.TIMEOUT) {
                            errorDiv.textContent = 'Location request timed out. Please try again.';
                            errorDiv.style.display = 'block';
                        } else {
                            errorDiv.textContent = 'Unable to retrieve your location. Please try again or enter your address.';
                            errorDiv.style.display = 'block';
                            document.getElementById('manual-address-input').style.display = 'block';
                        }
                    },
                    {timeout: 10000}
                );
            } else {
                errorDiv.textContent = 'Geolocation is not supported by your browser.';
                errorDiv.style.display = 'block';
                document.getElementById('manual-address-input').style.display = 'block';
            }
        } else {
            errorDiv.textContent = 'Location access is required to find meals near you.';
            errorDiv.style.display = 'block';
        }
    });

    document.getElementById('submit-address').addEventListener('click', function() {
        const errorDiv = document.getElementById('location-error-message');
        errorDiv.textContent = 'Manual address lookup is not supported in this demo. Please use location access.';
        errorDiv.style.display = 'block';
    });

    function fetchNearbyMealsList(lat, lng) {
        // Show the Meals Near You section
        document.getElementById('meals-nearby-section').style.display = 'block';
        // Hide map, show featured meals grid
        document.getElementById('nearby-meals-map').style.display = 'none';
        const sectionHeader = document.querySelector('#meals-nearby-section .section-header .section-title');
        if (sectionHeader) sectionHeader.textContent = 'Meals Near You';
        // Target the "Meals Near You" grid
        const grid = document.getElementById('nearby-meals-list');
        grid.innerHTML = '<p>Loading nearby meals...</p>';
        fetch('/buyers/api/nearby-meals/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ latitude: lat, longitude: lng })
        })
        .then(response => response.text())
        .then(text => {
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                grid.innerHTML = '<p>Server error: ' + text + '</p>';
                return;
            }
            if (data.success && data.cooks.length > 0) {
                grid.innerHTML = '';
                data.cooks.forEach(cook => {
                    const card = document.createElement('div');
                    card.className = 'meal-card';
                    card.innerHTML =
                        `<b>${cook.name}</b><br>` +
                        `${cook.meal_name}<br>` +
                        (cook.price ? `Price: ‚Çπ${cook.price}<br>` : '') +
                        `Distance: ${cook.distance_km} km<br>` +
                        `<a href='/buyers/meal/${cook.meal_id}/' target='_blank'>View Meal</a> ` +
                        `<button class='view-on-map-btn' data-lat='${cook.latitude}' data-lng='${cook.longitude}'>View on Map</button>`;
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = '<p>No meals found nearby.</p>';
            }
        })
        .catch((err) => {
            grid.innerHTML = '<p>Error fetching nearby meals.</p>';
        });
    }

    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('view-on-map-btn')) {
            const lat = parseFloat(e.target.getAttribute('data-lat'));
            const lng = parseFloat(e.target.getAttribute('data-lng'));
            showSingleMealOnMap(lat, lng);
        }
    });

    function showSingleMealOnMap(lat, lng) {
        const mapDiv = document.getElementById('nearby-meals-map');
        mapDiv.innerHTML = '';
        mapDiv.style.display = 'block';
        // Hide list
        document.getElementById('nearby-meals-list').style.display = 'none';
        const map = L.map(mapDiv).setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        L.marker([lat, lng]).addTo(map).bindPopup('Meal Location').openPopup();
    }

    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>

</body>
</html>
